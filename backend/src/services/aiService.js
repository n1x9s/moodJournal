const Mood = require('../models/Mood');

// AI suggestions based on user's mood patterns
const getPersonalizedSuggestions = async (userId) => {
  try {
    // Get recent moods
    const recentMoods = await Mood.find({ userId })
      .sort({ createdAt: -1 })
      .limit(30);

    const suggestions = [];

    if (recentMoods.length === 0) {
      // Default suggestions for new users
      return getDefaultSuggestions();
    }

    // Analyze mood patterns
    const avgMood = recentMoods.reduce((sum, m) => sum + m.level, 0) / recentMoods.length;
    const factors = recentMoods.flatMap(m => m.factors);

    // Count factors
    const factorCounts = {};
    factors.forEach(f => {
      factorCounts[f] = (factorCounts[f] || 0) + 1;
    });

    // Generate personalized suggestions
    if (avgMood < 3) {
      suggestions.push({
        id: 'low_mood_1',
        title: 'Техника глубокого дыхания',
        content: 'Попробуйте дыхательную практику 4-7-8: вдох 4 секунды, задержка 7 секунд, выдох 8 секунд',
        category: 'mindfulness',
        icon: 'wind'
      });
    }

    if (factorCounts['no_sleep'] > factorCounts['sleep']) {
      suggestions.push({
        id: 'sleep_1',
        title: 'Улучшение качества сна',
        content: 'Создайте ритуал перед сном: отключите экраны за час до сна, прочитайте книгу или помедитируйте',
        category: 'sleep',
        icon: 'moon.fill'
      });
    }

    if (!factors.includes('exercise') || factorCounts['exercise'] < 3) {
      suggestions.push({
        id: 'activity_1',
        title: 'Добавьте физическую активность',
        content: 'Даже 15 минут прогулки в день могут значительно улучшить настроение и самочувствие',
        category: 'activity',
        icon: 'figure.walk'
      });
    }

    if (factorCounts['friends'] < 2 && factorCounts['family'] < 2) {
      suggestions.push({
        id: 'social_1',
        title: 'Социальные связи',
        content: 'Позвоните другу или родственнику. Общение с близкими людьми положительно влияет на настроение',
        category: 'social',
        icon: 'person.2.fill'
      });
    }

    // Add general wellness suggestion
    suggestions.push({
      id: 'wellness_1',
      title: 'Благодарность',
      content: 'Запишите три вещи, за которые вы благодарны сегодня. Это простая практика улучшает эмоциональное состояние',
      category: 'wellness',
      icon: 'heart.fill'
    });

    return suggestions.slice(0, 5);
  } catch (error) {
    console.error('Error generating suggestions:', error);
    return getDefaultSuggestions();
  }
};

const getDefaultSuggestions = () => [
  {
    id: 'default_1',
    title: 'Начните вести дневник',
    content: 'Записывайте свои мысли и чувства ежедневно. Это поможет лучше понять себя',
    category: 'wellness',
    icon: 'book.fill'
  },
  {
    id: 'default_2',
    title: 'Медитация',
    content: 'Начните с 5 минут медитации в день. Это поможет снизить стресс и улучшить концентрацию',
    category: 'mindfulness',
    icon: 'brain.head.profile'
  },
  {
    id: 'default_3',
    title: 'Режим сна',
    content: 'Старайтесь ложиться и вставать в одно время. Регулярный сон — основа хорошего самочувствия',
    category: 'sleep',
    icon: 'moon.fill'
  },
  {
    id: 'default_4',
    title: 'Физическая активность',
    content: 'Найдите активность, которая вам нравится: прогулки, йога, танцы или спорт',
    category: 'activity',
    icon: 'figure.run'
  },
  {
    id: 'default_5',
    title: 'Общение',
    content: 'Поддерживайте связь с близкими людьми. Социальные связи важны для эмоционального благополучия',
    category: 'social',
    icon: 'person.2.fill'
  }
];

// Simple AI response generator (can be enhanced with OpenAI API)
const generateResponse = async (message, userId) => {
  const lowerMessage = message.toLowerCase();

  // Get user's recent mood data for context
  const recentMoods = await Mood.find({ userId })
    .sort({ createdAt: -1 })
    .limit(7);

  let response = '';

  // Pattern matching for common questions
  if (lowerMessage.includes('настроение') && (lowerMessage.includes('улучшить') || lowerMessage.includes('поднять'))) {
    response = `Вот несколько способов улучшить настроение прямо сейчас:

1. **Дыхательная практика**: Сделайте несколько глубоких вдохов и выдохов. Это активирует парасимпатическую нервную систему и помогает расслабиться.

2. **Движение**: Даже короткая прогулка или растяжка может значительно улучшить самочувствие благодаря выработке эндорфинов.

3. **Музыка**: Послушайте любимую музыку — это быстрый способ поднять настроение.

4. **Благодарность**: Подумайте о трёх вещах, за которые вы благодарны сегодня.

5. **Общение**: Позвоните другу или напишите близкому человеку.`;
  } else if (lowerMessage.includes('сон') || lowerMessage.includes('спать') || lowerMessage.includes('бессонница')) {
    response = `Вот рекомендации для улучшения качества сна:

1. **Режим**: Старайтесь ложиться и вставать в одно время, даже в выходные.

2. **Ритуал перед сном**: За час до сна отключите яркие экраны, примите тёплый душ, почитайте книгу.

3. **Обстановка**: Сделайте спальню тёмной, тихой и прохладной (18-20°C).

4. **Кофеин**: Избегайте кофе и чая за 6-8 часов до сна.

5. **Техника 4-7-8**: Вдох 4 секунды, задержка 7 секунд, выдох 8 секунд. Повторите 3-4 раза.

6. **Записывайте мысли**: Если не можете заснуть из-за мыслей, запишите их — это поможет "выгрузить" их из головы.`;
  } else if (lowerMessage.includes('стресс') || lowerMessage.includes('тревога') || lowerMessage.includes('нервничаю')) {
    response = `Понимаю, справляться со стрессом непросто. Вот что может помочь:

1. **Дыхание**: Техника "квадратного дыхания" — вдох 4 сек, задержка 4 сек, выдох 4 сек, задержка 4 сек.

2. **Заземление**: Техника 5-4-3-2-1: найдите 5 предметов, которые видите, 4 звука, 3 текстуры, 2 запаха, 1 вкус.

3. **Физическая активность**: Даже 10 минут быстрой ходьбы снижают уровень кортизола.

4. **Ограничьте новости**: Постоянный поток информации усиливает тревогу.

5. **Поговорите**: Расскажите о своих переживаниях близкому человеку или специалисту.

Помните: испытывать стресс — это нормально. Важно находить здоровые способы с ним справляться.`;
  } else if (lowerMessage.includes('грустно') || lowerMessage.includes('плохо') || lowerMessage.includes('депресс')) {
    response = `Мне жаль, что вам сейчас непросто. Вот несколько мыслей:

1. **Позвольте себе чувствовать**: Грусть — это нормальная эмоция. Не нужно её подавлять.

2. **Маленькие шаги**: Начните с чего-то простого — встаньте с кровати, примите душ, выйдите на свежий воздух.

3. **Движение**: Физическая активность реально помогает — даже небольшая прогулка.

4. **Общение**: Поговорите с кем-то, кому доверяете. Иногда просто выговориться уже помогает.

5. **Рутина**: Поддержание простой рутины (сон, еда, движение) помогает в сложные периоды.

⚠️ Если грусть длится долго или мешает жить, пожалуйста, обратитесь к психологу или психотерапевту. Это не слабость, а забота о себе.`;
  } else if (lowerMessage.includes('релакс') || lowerMessage.includes('расслаб')) {
    response = `Вот техники релаксации, которые можно попробовать:

**Прогрессивная мышечная релаксация:**
Поочерёдно напрягайте и расслабляйте группы мышц, начиная с ног и заканчивая лицом. Напряжение 5 секунд, расслабление 10 секунд.

**Визуализация:**
Закройте глаза и представьте спокойное место — пляж, лес, горы. Задействуйте все органы чувств: что вы видите, слышите, чувствуете?

**Дыхание животом:**
Положите руку на живот. При вдохе живот поднимается, при выдохе — опускается. Медленно, глубоко.

**Медитация осознанности:**
Сосредоточьтесь на настоящем моменте. Наблюдайте за дыханием, звуками вокруг, ощущениями в теле без оценки.

**Музыка и звуки природы:**
Спокойная музыка или звуки природы могут помочь расслабиться.`;
  } else {
    // Default response
    if (recentMoods.length > 0) {
      const avgMood = recentMoods.reduce((sum, m) => sum + m.level, 0) / recentMoods.length;
      const moodDescription = avgMood >= 4 ? 'хорошим' : avgMood >= 3 ? 'нормальным' : 'непростым';

      response = `Спасибо за сообщение! Я вижу, что в последнее время ваше настроение было ${moodDescription}.

Я могу помочь с:
- Советами по улучшению настроения
- Техниками релаксации и управления стрессом
- Рекомендациями по улучшению сна
- Практиками осознанности

Просто спросите о том, что вас интересует!`;
    } else {
      response = `Рад познакомиться! Я ваш AI-помощник в приложении "Дневник настроения".

Я могу помочь вам с:
- **Улучшением настроения** — дам конкретные советы и техники
- **Управлением стрессом** — расскажу о методах релаксации
- **Качеством сна** — поделюсь рекомендациями для лучшего отдыха
- **Эмоциональным благополучием** — помогу разобраться в чувствах

Начните регулярно отмечать своё настроение, и я смогу давать более персонализированные рекомендации!

Что бы вы хотели обсудить?`;
    }
  }

  return response;
};

module.exports = { getPersonalizedSuggestions, generateResponse };
